import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const ROOT_DIR = path.resolve(__dirname, '..');
const DOCS_DIR = path.join(ROOT_DIR, 'app/docs');
const COMPONENTS_DIR = path.join(DOCS_DIR, 'components');
const EXTRAS_DIR = path.join(DOCS_DIR, 'nova-extras');
const OUTPUT_FILE = path.join(ROOT_DIR, 'lib/docs-config.ts');

const DEFAULT_VERSIONS = ["1.0.0", "1.1.0", "2.0.0-beta"];

function getVersions(dir) {
  if (!fs.existsSync(dir)) return {};
  
  const components = {};
  const items = fs.readdirSync(dir, { withFileTypes: true });
  
  for (const item of items) {
    if (item.isDirectory()) {
      const componentName = item.name;
      const componentPath = path.join(dir, componentName);
      const files = fs.readdirSync(componentPath);
      
      const versions = files
        .filter(f => f.startsWith('v') && f.endsWith('.tsx'))
        .map(f => f.replace(/^v/, '').replace(/\.tsx$/, ''))
        .sort((a, b) => {
             return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
        });
      
      if (versions.length > 0) {
        components[componentName] = versions;
      } else if (fs.existsSync(path.join(componentPath, 'page.tsx'))) {
        // If page.tsx exists but no explicit version file, assume all default versions
        components[componentName] = DEFAULT_VERSIONS;
      }
    }
  }
  return components;
}

const componentVersions = getVersions(COMPONENTS_DIR);
const novaExtrasVersions = getVersions(EXTRAS_DIR);

const content = `// This file is auto-generated by scripts/generate-docs-data.mjs
// Do not edit this file manually.

export const componentVersions = ${JSON.stringify(componentVersions, null, 2)} as const;

export const novaExtrasVersions = ${JSON.stringify(novaExtrasVersions, null, 2)} as const;
`;

fs.writeFileSync(OUTPUT_FILE, content);
console.log(`Generated docs config at ${OUTPUT_FILE}`);
